version: '3.7'

# a stack-file version of this for running in Swarm services

services:
  node:
    # reminder, don't use latest tag in production, use versions created by CI/CD
    image: registry.gitlab.com/aristofun/docker-tests/socketchat-app:latest
    env_file: ./config/${NODE_ENV:-production}.env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
    deploy:
      replicas: 1
      update_config:
        order: stop-first

  nginx:
    image: registry.gitlab.com/aristofun/docker-tests/socketchat-nginx:latest
    ports:
      - "80:80"
      - "443:443"
      - "8088:8088"
    volumes:
      - certs:/etc/letsencrypt
#      - ./data/certbot/www:/var/www/certbot
    deploy:
      replicas: 1
      update_config:
        order: stop-first


#  certbot:
#    build: .
#    image: ebarault/letsencrypt-autorenew-docker:latest
#    ports:
#      - "443:443"
#    volumes:
#      - certs:/certs
#      - ./letsencrypt:/etc/letsencrypt
#      - ./var_log_letsencrypt:/var/log/letsencrypt
#    restart: always
#    environment:
# - WEBROOT=/path/to/web_root
#      - LOGFILE=/var/log/letsencrypt/certrenewal.log
#      - DEBUG=false
#      - STAGING=false
#      - DOMAINS=chat.tubi.ru
#      - EMAIL=boatman@list.ru
#      - CONCAT=false
#      - HEALTH_CHECK_URL=chat.tubi.ru:80


volumes:
  certs:

#secrets:
#  mongo_root:
#    file: ...